<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Asteroid Impact Risk Simulator — Impact</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" crossorigin="anonymous" defer onload="renderMathInElement(document.body);"></script>
  <style>
    :root{ --bg:#000; --card:rgba(10,10,20,0.85); --amber:#FFC107; --muted:#9ca3af; --glass-border:rgba(255,165,0,0.12); }
    html,body{ height:100%; margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#e5e7eb; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .font-mono-space{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .digital-glow{ text-shadow:0 0 10px rgba(255,192,0,0.7), 0 0 25px rgba(255,140,0,0.5); }
    .dark-card{ background:var(--card); backdrop-filter: blur(8px) saturate(1.2); border:1px solid var(--glass-border); box-shadow:0 8px 40px rgba(255,165,0,0.05); border-radius:16px; }
    .holo-bubble{ background:rgba(0,0,0,0.42); border:2px solid rgba(255,165,0,0.12); padding:10px; border-radius:14px; box-shadow: inset 0 0 10px rgba(255,165,0,0.06), 0 6px 18px rgba(0,0,0,0.6); transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease; }
    .holo-bubble:focus-within{ border-color: rgba(255,193,7,0.9); box-shadow: inset 0 0 25px rgba(255,193,7,0.08), 0 10px 30px rgba(255,165,0,0.08); transform: translateY(-2px); }
    .bubble-select{ appearance:none; -webkit-appearance:none; color:#f8fafc; background:transparent; border:none; outline:none; padding:8px 10px; font-size:.95rem; width:100%; cursor:pointer; }
    .select-wrap{ position:relative; }
    .select-wrap::after{ content:'▾'; position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#fbbf24; pointer-events:none; font-size:.85rem; }
    #impact-map{ height:520px; width:100%; border-radius:12px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.6); border:1px solid rgba(255,165,0,0.06); background:linear-gradient(180deg, rgba(17,24,39,0.85), rgba(10,10,20,0.85)); }
    .prob-row{ display:flex; gap:12px; align-items:center; }
    .prob-name{ width:190px; color:#d1d5db; font-weight:600; }
    .prob-bar-wrap{ background:rgba(255,255,255,0.04); border-radius:999px; height:22px; flex:1; position:relative; overflow:hidden; border:1px solid rgba(255,255,255,0.03); }
    .prob-fill{ height:100%; transition: width .8s cubic-bezier(.2,.9,.2,1); display:flex; align-items:center; justify-content:flex-end; padding-right:10px; color:#071019; font-weight:700; font-family: ui-monospace, monospace; border-radius:999px; }
    .prob-value-label{ width:60px; text-align:right; font-family: ui-monospace; color:#e5e7eb; font-weight:700; }
    @media (max-width:1024px){ #impact-map{ height:420px; } .prob-name{ width:140px; font-size:.9rem; } }
    @media (max-width:640px){ #impact-map{ height:320px; } .prob-name{ width:120px; font-size:.8rem; } }
    @keyframes twinkle{ 0%,100%{ opacity:.7 } 50%{ opacity:1 } }
    body::after{ content:''; position:fixed; inset:0; background-image: radial-gradient(1px 1px at 20px 40px,#fff 50%, transparent 51%); opacity:.02; pointer-events:none; z-index:-10; animation: twinkle 12s infinite; }
    .pulse-fire-shadow{ box-shadow:0 0 0 0 rgba(239,68,68,0.6); animation: firePulse 1.8s infinite; }
    @keyframes firePulse{ 0%{ box-shadow:0 0 0 0 rgba(239,68,68,0.5);} 70%{ box-shadow:0 0 0 10px rgba(239,68,68,0);} 100%{ box-shadow:0 0 0 0 rgba(239,68,68,0);} }
    #severity-bar{ background: linear-gradient(90deg,#10b981,#f59e0b,#f97316,#ef4444); height:40px; border-radius:999px; position:relative; }
    #severity-indicator{ position:absolute; top:-8px; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 12px solid #fef3c7; filter: drop-shadow(0 2px 2px rgba(0,0,0,.4)); }
  </style>
</head>
<body class="min-h-screen p-6 sm:p-10">
  <div id="app" class="max-w-6xl mx-auto">
    <header class="text-center mb-8">
      <h1 class="text-4xl sm:text-5xl font-extrabold text-amber-400 digital-glow mb-2 font-mono-space tracking-wide">IMPACT ENERGY CALCULATOR</h1>
      <p class="text-sm text-gray-400">Calculate kinetic energy and visualize predicted blast radii + consequence probabilities by country/city.</p>
    </header>

    <section id="inputs" class="dark-card p-6 rounded-2xl mb-8">
      <h2 class="text-lg font-bold text-orange-400 digital-glow mb-4">ASTEROID PARAMETERS</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="holo-bubble p-4">
          <label class="text-xs text-gray-300 block mb-2">Mass (kg)</label>
          <input id="mass-input" type="number" value="1000000" min="0" step="1000" oninput="calculateEnergy()" class="bubble-select font-mono-space text-2xl bg-transparent" />
          <p class="text-xs text-gray-400 mt-2">Example: 1,000,000 kg</p>
        </div>
        <div class="holo-bubble p-4">
          <label class="text-xs text-gray-300 block mb-2">Velocity (km/s)</label>
          <input id="velocity-input" type="number" value="20" min="0" step="0.1" oninput="calculateEnergy()" class="bubble-select font-mono-space text-2xl bg-transparent" />
          <p class="text-xs text-gray-400 mt-2">Typical range: 11–72 km/s</p>
        </div>
        <div id="data-bubbles" class="holo-bubble p-4 text-center">
          <p class="text-sm text-red-400 font-semibold mb-2">TNT Equivalent (MT)</p>
          <div class="text-3xl font-extrabold text-amber-300 font-mono-space digital-glow" id="tnt-output">0 MT</div>
          <div id="ke-output" class="text-xs text-gray-400 mt-1 font-mono-space"></div>
        </div>
      </div>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <aside id="severity-panel" class="dark-card p-6 rounded-xl">
        <h3 class="text-xl font-extrabold text-red-400 digital-glow mb-4 font-mono-space">PLANETARY HAZARD SCALE (PHS)</h3>
        <div id="severity-description-container" class="text-center mb-6">
          <div id="severity-title" class="text-lg font-bold text-green-400">LOADING DATA...</div>
          <div id="severity-subtext" class="text-xs text-gray-400 mt-1">Estimating impact consequences.</div>
        </div>
        <div class="mb-6 relative">
          <div id="severity-bar" class="rounded-full"></div>
          <div id="severity-indicator" style="left:0%"></div>
          <div class="absolute w-full flex justify-between" style="top:3.5rem;">
            <span class="text-xs text-gray-400 font-mono-space">0.1 MT</span>
            <span class="text-xs text-gray-400 font-mono-space">10 MT</span>
            <span class="text-xs text-gray-400 font-mono-space">100 MT</span>
            <span class="text-xs text-gray-400 font-mono-space">1,000 MT</span>
            <span class="text-xs text-gray-400 font-mono-space">10k+ MT</span>
          </div>
        </div>
        <h4 class="text-lg font-bold text-amber-300 mb-3">CONSEQUENCE REPORT</h4>
        <ul class="space-y-3">
          <li class="p-3 bg-gray-900/30 rounded-lg flex justify-between items-center"><span class="text-red-400 font-semibold">Fireball Radius:</span><span id="fireball-radius" class="font-mono-space">0.0 km</span></li>
          <li class="p-3 bg-gray-900/30 rounded-lg flex justify-between items-center"><span class="text-orange-400 font-semibold">Severe Damage Radius (5 psi):</span><span id="severe-damage-radius" class="font-mono-space">0.0 km</span></li>
          <li class="p-3 bg-gray-900/30 rounded-lg flex justify-between items-center"><span class="text-yellow-400 font-semibold">Thermal Burn Radius (3rd degree):</span><span id="thermal-radius" class="font-mono-space">0.0 km</span></li>
          <li class="p-3 bg-gray-900/30 rounded-lg flex justify-between items-center"><span class="text-blue-400 font-semibold">Tsunami Potential:</span><span id="tsunami-risk" class="font-mono-space text-green-300">NONE</span></li>
        </ul>
      </aside>

      <section id="map-section" class="dark-card p-6 rounded-xl">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-amber-400 digital-glow font-mono-space">GLOBAL IMPACT VISUALIZER</h3>
          <div class="text-sm text-gray-400">Click map to set location</div>
        </div>
        <div class="text-xs text-gray-400 mb-3">Impact Lat/Lng: <span id="lat-lng-display" class="font-mono-space text-yellow-400">40.7128, -74.0060</span></div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
          <div class="holo-bubble select-wrap">
            <label class="text-xs text-gray-300 mb-1 block">Select Country</label>
            <select id="country-select" class="bubble-select" onchange="onCountryChange(this.value)">
              <option value="">Choose country or click map</option>
              <option value="US">United States</option>
              <option value="JP">Japan</option>
              <option value="CN">China</option>
              <option value="IN">India</option>
              <option value="BR">Brazil</option>
              <option value="RU">Russia</option>
              <option value="AU">Australia</option>
              <option value="ZA">South Africa</option>
              <option value="GB">United Kingdom</option>
              <option value="FR">France</option>
              <option value="DE">Germany</option>
              <option value="CA">Canada</option>
              <option value="MX">Mexico</option>
            </select>
          </div>
          <div class="holo-bubble select-wrap">
            <label class="text-xs text-gray-300 mb-1 block">Major City</label>
            <select id="city-select" class="bubble-select" onchange="onCityChange(this.value)">
              <option value="">Choose city</option>
            </select>
          </div>
        </div>
        <div id="impact-map" class="mb-4"></div>
        <div id="probability-chart" class="mt-4">
          <h4 class="text-lg font-bold text-amber-400 mb-3">IMPACT CONSEQUENCE PROBABILITY (by city/country)</h4>
          <div id="probability-bars" class="space-y-3"></div>
        </div>
      </section>
    </div>

    <section id="historical-comparison" class="dark-card p-6 rounded-xl mt-8">
      <h3 class="text-xl font-bold text-amber-400 digital-glow mb-4 font-mono-space">COMPARATIVE ENERGY MATRIX</h3>
      <div class="overflow-x-auto">
        <table class="w-full text-left text-sm">
          <thead>
            <tr class="text-gray-400 border-b border-gray-700">
              <th class="p-2 font-semibold">Event</th>
              <th class="p-2 font-semibold text-right">Yield (MT)</th>
              <th class="p-2 font-semibold text-center">Relative Power</th>
            </tr>
          </thead>
          <tbody id="comparison-body" class="font-mono-space"></tbody>
        </table>
      </div>
    </section>

    <footer class="text-center text-xs text-gray-500 mt-6">
      Built for NASA Space Apps — Impact module.
    </footer>
  </div>

  <!-- Inline JS copied from your snippet, with secure Maps loading -->
  <script>
  /* The entire JS from your snippet is preserved below, with one change: MAPS_API_KEY is omitted.
     We dynamically load Google Maps using /config to verify the key is present on server, but we still load the script via browser (as required by Maps JS). */
  </script>
  <script>
  // Load Maps key securely from server, then inject script
  (function(){
    function loadMaps() {
      fetch('/maps-key').then(r => r.json()).then(({ key }) => {
        const s = document.createElement('script');
        s.src = `https://maps.googleapis.com/maps/api/js?key=${key}&callback=initMap`;
        s.async = true; s.defer = true; s.onerror = () => {
          const m = document.getElementById('impact-map');
          if (m) m.innerHTML = '<div style="padding:20px;color:#f97316">Failed to load Google Maps. Check your MAPS_API_KEY.</div>';
        };
        document.head.appendChild(s);
      }).catch(() => {
        const m = document.getElementById('impact-map');
        if (m) m.innerHTML = '<div style="padding:20px;color:#f97316">Missing MAPS_API_KEY on server.</div>';
      });
    }
    window.addEventListener('DOMContentLoaded', loadMaps);
  })();
  </script>
  <!-- Paste your original long <script> from the snippet here if you prefer keeping one file; or split to impact.js -->
</body>
</html>


